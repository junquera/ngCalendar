<html>
    <head>
      <!-- Latest compiled and minified CSS -->
      <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">

      <!-- Optional theme -->
      <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap-theme.min.css" integrity="sha384-rHyoN1iRsVXV4nD0JutlnGaslCJuC7uwjduW9SVrLvRYooPp2bWYgmgJQIXwl/Sp" crossorigin="anonymous">

        <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.6.5/angular.min.js"></script>
        <script>
          var app = angular.module("myApp", []);

          class Calendario extends Date {
            get months() {
              return {
                'ES': ['ENE', 'FEB', 'MAR', 'ABR', 'MAY', 'JUN', 'JUL', 'AGO', 'SEP', 'OCT', 'NOV', 'DIC'],
                'EN': ['JAN', 'FEB', 'MAR', 'APR', 'MAY', 'JUN', 'JUL', 'AUG', 'SEP', 'OCT', 'NOV', 'DEC']
              }
            }
            get day() {
              return this.getUTCDate();
            }

            get month() {
              return this.getUTCMonth();
            }

            get year() {
               return this.getUTCFullYear();
            }

            get week_day() {
               return this.getUTCDay();
            }

            set day(v)  {
              this.setUTCDate(v);
            }

            set month(v) {
              this.setUTCMonth(v);
            }

            set year(v) {
               this.setUTCFullYear(v);
            }

            nextDay() {
              this.day = this.day + 1;
            }

            prevDay() {
              this.day = this.day - 1;
            }

            nextMonth() {
              this.month = this.month + 1;
            }

            prevMonth() {
              this.month = this.month - 1;
            }

            nextYear() {
              this.year = this.year + 1;
            }

            prevYear() {
              this.year = this.year - 1;
            }

            month_text(LANG) {
              if(typeof(LANG) == 'undefined')
                LANG = 'ES';
              return this.months[LANG][this.month];
            }

            // TODO Cambiar esto por método estático
            get array() {

              var aux = new Calendario(this);

              while( aux.day > 1 ){
                aux.prevDay();
              }

              // > 1 because monday is 0
              while( aux.week_day > 1 ){
                aux.prevDay();
              }

              // "Padding" para evitar que se acumulen muchas
              // semanas del mes siguiente al final de la tabla
              if ( aux.day == 1 )
                for(var i = 0; i < 7; i++)
                  aux.prevDay();

              var result = [];
              for(let i = 0; i <= 5; i++){
                var rows = [];
                for(let j = 0; j < 7; j++){
                  rows.push({'day': aux.day, 'month': aux.month});
                  aux.nextDay();
                }
                result.push(rows);
              }

              return result;
            }
          };

          var f = new Calendario();
          app.controller("MainController", function($scope){
            $scope.app = "Calendario";
          });
          // https://docs.angularjs.org/guide/directive
          app.directive("myCal",function(){
              var d = new Date();
              var today = {
                day: d.getUTCDate(),
                month: d.getUTCMonth(),
                year: d.getUTCFullYear(),
                week_day: d.getUTCDay(),

              }
              var f = new Calendario();
              return {
                restrict: 'E',
                templateUrl: 'cal-template.html',
                controller: function($scope){
                  $scope.dir = "Hola";
                  $scope.fecha = new Calendario();
                  $scope.calendario = $scope.fecha.array;
                  $scope.nextMonth = function(){
                    $scope.fecha.nextMonth();
                    $scope.calendario = $scope.fecha.array;
                  }
                  $scope.prevMonth = function(){
                    $scope.fecha.prevMonth();
                    $scope.calendario = $scope.fecha.array;
                  }
                }
              };
          });
        </script>
    </head>
    <body ng-app="myApp" ng-controller="MainController">
      <h1>{{ app }}</h1>
      <my-cal></my-cal>


    </body>

</html>
