<html>
    <head>
      <!-- Latest compiled and minified CSS -->
      <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
      <link href="https://fonts.googleapis.com/css?family=Roboto" rel="stylesheet">
      <!-- Optional theme -->
      <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap-theme.min.css" integrity="sha384-rHyoN1iRsVXV4nD0JutlnGaslCJuC7uwjduW9SVrLvRYooPp2bWYgmgJQIXwl/Sp" crossorigin="anonymous">

        <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.6.5/angular.min.js"></script>
        <script>
          var app = angular.module("myApp", []);

          class Calendario extends Date {
            get months() {
              return {
                'ES': ['ENE', 'FEB', 'MAR', 'ABR', 'MAY', 'JUN', 'JUL', 'AGO', 'SEP', 'OCT', 'NOV', 'DIC'],
                'EN': ['JAN', 'FEB', 'MAR', 'APR', 'MAY', 'JUN', 'JUL', 'AUG', 'SEP', 'OCT', 'NOV', 'DEC']
              }
            }
            get day() {
              return this.getUTCDate();
            }

            get month() {
              return this.getUTCMonth();
            }

            get year() {
               return this.getUTCFullYear();
            }

            get week_day() {
               return (this.getUTCDay() + 6) % 7 ;
            }

            set day(v)  {
              this.setUTCDate(v);
            }

            set month(v) {
              this.setUTCMonth(v);
            }

            set year(v) {
               this.setUTCFullYear(v);
            }


            nextDay() {
              this.day = this.day + 1;
              return this;
            }

            prevDay() {
              this.day = this.day - 1;
              return this;
            }

            /*
              TODO Arreglar problema al añadir mes partiendo desde un día "extra" (ej. día 31)
              Ver cómo puede afectar al cambio de mes hacerlo siempre aumentando hasta el día 1
            */
            nextMonth() {
              this.month = this.month + 1;
            }

            prevMonth() {
              this.month = this.month - 1;
            }

            nextYear() {
              this.year = this.year + 1;
            }

            prevYear() {
              this.year = this.year - 1;
            }

            month_text(LANG) {
              if(typeof(LANG) == 'undefined')
                LANG = 'ES';
              return this.months[LANG][this.month];
            }

            get array() {
              var aux = new Calendario(this);

              while( aux.day > 1 ){
                aux.prevDay();
              }

              // > 1 because monday is 0
              while( aux.week_day > 0 ){
                aux.prevDay();
              }

              // "Padding" para evitar que se acumulen muchas
              // semanas del mes siguiente al final de la tabla
              if ( aux.day == 1 )
                for(var i = 0; i < 7; i++)
                  aux.prevDay();


              var result = [];
              for(let i = 0; i <= 5; i++){
                var rows = [];
                for(let j = 0; j < 7; j++){
                  rows.push(new Calendario(aux));
                  aux.nextDay();
                }
                result.push(rows);
              }

              return result;
            }
          };

          var f = new Calendario();
          app.controller("MainController", function($scope){
            $scope.app = "Calendario";
          });

          app.directive("myCal",function(){
              var d = new Date();
              var today = {
                day: d.getUTCDate(),
                month: d.getUTCMonth(),
                year: d.getUTCFullYear(),
                week_day: d.getUTCDay(),
              }
              // TODO Arreglar problema con octubre de 2018
              var f = new Calendario();
              return {
                restrict: 'E',
                templateUrl: 'cal-template.html',
                controller: function($scope){
                  $scope.dir = "Hola";
                  $scope.console = {'log': console.log};

                  $scope.fecha = new Calendario();
                  $scope.today = new Calendario();
                  $scope.selected = new Calendario().nextDay();


                  $scope.calendario = $scope.fecha.array;
                  $scope.nextMonth = function(){
                    $scope.fecha.nextMonth();
                    $scope.calendario = $scope.fecha.array;
                  }
                  $scope.prevMonth = function(){
                    $scope.fecha.prevMonth();
                    $scope.calendario = $scope.fecha.array;
                  }
                  $scope.isSelected = function(day){
                    return day.getTime() == $scope.selected.getTime();
                  }
                  $scope.select = function(day){
                    var selected = new Calendario(day.day);

                    if(selected.month > $scope.fecha.month){
                      if(selected.year >= $scope.fecha.year){
                        $scope.nextMonth();
                      } else {
                        $scope.prevMonth();
                      }
                    } else if (selected.month < $scope.fecha.month){
                      if(selected.year <= $scope.fecha.year)
                        $scope.prevMonth();
                      else
                        $scope.nextMonth();
                    }

                    $scope.selected = new Calendario(selected);
                  }
                }
              };
          });
        </script>
    </head>
    <body ng-app="myApp" ng-controller="MainController">
      <h1>{{ app }}</h1>
      <my-cal></my-cal>


    </body>

</html>
